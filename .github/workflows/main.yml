name: Windows Native Web
on:
  workflow_dispatch:
    inputs:
      password:
        required: true

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' 

    - name: Install Tools
      shell: powershell
      run: |
        Write-Host "Downloading Tools..."
        Invoke-WebRequest "https://www.tightvnc.com/download/2.8.84/tightvnc-2.8.84-gpl-setup-64bit.msi" -OutFile "tightvnc.msi"
        Start-Process msiexec.exe -ArgumentList "/i tightvnc.msi /quiet /norestart" -Wait
        Invoke-WebRequest "https://github.com/novnc/noVNC/archive/refs/tags/v1.5.0.zip" -OutFile "novnc.zip"
        Expand-Archive novnc.zip -DestinationPath "C:\\"
        Move-Item "C:\\noVNC-1.5.0" "C:\\noVNC"
        pip install websockify

    - name: Configure VNC
      shell: powershell
      run: |
        New-Item -Path "HKLM:\SOFTWARE\TightVNC\Server" -Force | Out-Null
        New-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "AllowLoopback" -Value 1 -PropertyType DWORD -Force
        New-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "AuthenticationLevel" -Value 0 -PropertyType DWORD -Force
        Start-Process "C:\\Program Files\\TightVNC\\tvnserver.exe" -ArgumentList "-run" -WindowStyle Hidden
        Start-Sleep -Seconds 3
        Start-Process "python" -ArgumentList "-m websockify 6080 127.0.0.1:5900 --web C:\\noVNC" -WindowStyle Hidden

    - name: Cloudflare Tunnel
      shell: powershell
      run: |
        Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
        Start-Process ".\cloudflared.exe" -ArgumentList "tunnel --url http://127.0.0.1:6080" -RedirectStandardOutput "tunnel.log" -RedirectStandardError "tunnel.log" -WindowStyle Hidden

    - name: Show Link
      shell: powershell
      run: |
        $url = "Finding Link..."
        Write-Host "Searching for Cloudflare Link..."
        
        for ($i=0; $i -lt 60; $i++) {
            if (Test-Path tunnel.log) {
                $found = Select-String -Path "tunnel.log" -Pattern 'https://[-a-z0-9]+\.trycloudflare\.com'
                if ($found) {
                    $rawLink = $found.Matches[0].Value
                    $url = "$rawLink/vnc.html"
                    break
                }
            }
            Start-Sleep -Seconds 2
        }
        
        Write-Host " "
        Write-Host "========================================" -ForegroundColor Green
        Write-Host "       WINDOWS WEB INTERFACE READY" -ForegroundColor Green
        Write-Host "========================================" -ForegroundColor Green
        Write-Host "LINK: $url" -ForegroundColor Cyan
        Write-Host "PASS: ${{ inputs.password }}" -ForegroundColor Yellow
        Write-Host "NOTE: If repo is PUBLIC, you get 4 Logical Cores." -ForegroundColor White
        Write-Host "========================================" -ForegroundColor Green

    - name: Keep Alive
      run: start-sleep 21600
