name: Windows Native
on:
  workflow_dispatch:
    inputs:
      password:
        description: 'Set Password VNC'
        required: true

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
    - uses: actions/checkout@v4
    
    - name: 1. Install & Config (Full Logic)
      shell: powershell
      run: |
        Write-Host "üì• Downloading Tools..."
        Invoke-WebRequest "https://www.tightvnc.com/download/2.8.63/tightvnc-2.8.63-gpl-setup-64bit.msi" -OutFile "tightvnc.msi"
        Invoke-WebRequest "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"
        
        Write-Host "üíø Installing TightVNC..."
        # Logic c√†i ƒë·∫∑t y h·ªát th·∫±ng kia: Set pass, cho ph√©p loopback, ƒëƒÉng k√Ω service
        Start-Process msiexec.exe -ArgumentList "/i tightvnc.msi /quiet /norestart ADDLOCAL=Server SERVER_REGISTER_AS_SERVICE=1 SERVER_ADD_FIREWALL_EXCEPTION=1 SET_USEVNCAUTHENTICATION=1 VALUE_OF_USEVNCAUTHENTICATION=1 SET_PASSWORD=1 VALUE_OF_PASSWORD=${{ inputs.password }} SET_ACCEPTHTTPCONNECTIONS=1 VALUE_OF_ACCEPTHTTPCONNECTIONS=1 SET_ALLOWLOOPBACK=1 VALUE_OF_ALLOWLOOPBACK=1" -Wait
        
        Write-Host "üîß Registry Hacks..."
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "AllowLoopback" -Value 1 -ErrorAction SilentlyContinue
        
        Write-Host "üêç Setup Python Environment..."
        pip install --upgrade pip
        pip install numpy novnc websockify
        
        Write-Host "üõ°Ô∏è Firewall Rules..."
        netsh advfirewall firewall add rule name="Allow VNC" dir=in action=allow protocol=TCP localport=5900
        netsh advfirewall firewall add rule name="Allow Web" dir=in action=allow protocol=TCP localport=6080

    - name: 2. Start Services
      shell: powershell
      run: |
        Write-Host "üöÄ Starting VNC..."
        Start-Process "C:\Program Files\TightVNC\tvnserver.exe" -ArgumentList "-run -localhost no" -WindowStyle Hidden
        Start-Sleep -Seconds 5
        
        Write-Host "üöÄ Starting Websockify (NoVNC)..."
        # T√¨m ƒë∆∞·ªùng d·∫´n noVNC c√†i qua pip ƒë·ªÉ map v√†o web
        $novncInfo = pip show novnc
        $novncPath = ($novncInfo | Select-String "Location: (.*)").Matches.Groups[1].Value + "\novnc"
        Start-Process "python" -ArgumentList "-m websockify 6080 127.0.0.1:5900 --web $novncPath" -WindowStyle Hidden
        
        Write-Host "üöÄ Starting Cloudflare Tunnel..."
        # Ghi log ra file ƒë·ªÉ t√≠ n·ªØa ƒë·ªçc, nh∆∞ng kh√¥ng upload file n√†y
        Start-Process ".\cloudflared.exe" -ArgumentList "tunnel --url http://127.0.0.1:6080" -RedirectStandardOutput "tunnel.log" -RedirectStandardError "tunnel_err.log" -WindowStyle Hidden

    - name: 3. SHOW LINK IN CONSOLE
      shell: powershell
      run: |
        $url = "Finding..."
        Write-Host "üîç Searching for Tunnel URL in logs..."
        
        for ($i=0; $i -lt 40; $i++) {
            # T√¨m trong file error (Cloudflare hay in link ·ªü ƒë√¢y)
            if (Test-Path tunnel_err.log) {
                $c = Get-Content tunnel_err.log -Raw -ErrorAction SilentlyContinue
                if ($c -match 'https://[a-zA-Z0-9-]+\.trycloudflare\.com') {
                    $url = $matches[0] + "/vnc.html"
                    break
                }
            }
            Start-Sleep -Seconds 3
        }
        
        # IN TO R√ï R√ÄNG RA M√ÄN H√åNH
        Write-Host " "
        Write-Host "========================================================" -ForegroundColor Green
        Write-Host "           WINDOWS WEB INTERFACE READY" -ForegroundColor Green
        Write-Host "========================================================" -ForegroundColor Green
        Write-Host " "
        Write-Host "üîó LINK: $url" -ForegroundColor Cyan
        Write-Host " "
        Write-Host "üîë PASS: ${{ inputs.password }}" -ForegroundColor Yellow
        Write-Host " "
        Write-Host "‚ÑπÔ∏è  NOTE: Click link above to access Windows." -ForegroundColor White
        Write-Host "========================================================" -ForegroundColor Green

    - name: Keep Alive
      run: start-sleep 21600
